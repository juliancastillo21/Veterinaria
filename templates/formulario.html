<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veterinaria - Registro de Vacas</title>
    <link rel="stylesheet" href="../static/common.css">
    <link rel="stylesheet" href="../static/formulario.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üêÑ Veterinaria</h1>
            <h2>Registro de Orde√±o</h2>
        </header>

        <div class="nav-buttons">
            <button onclick="window.location.href='/'" class="btn-nav">üè† Volver al Inicio</button>
        </div>

        <div class="form-container">
            <form id="vacaForm" action="{{ form_action }}" method="POST" enctype="multipart/form-data" data-is-edit="{{ '1' if edicion else '0' }}" data-has-image="{{ '1' if registro and registro.imagen_base64 else '0' }}">
                
                <!-- Secci√≥n 1: Informaci√≥n del Orde√±ador -->
                <div class="form-section">
                    <h3 class="section-title">üë§ Informaci√≥n del Orde√±ador</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre_ordenador">Nombre del Orde√±ador:</label>
                            <div class="input-action">
                                <input type="text" id="nombre_ordenador" name="nombre_ordenador" required placeholder="Ingrese el nombre del orde√±ador" value="{{ registro.nombre_ordenador if registro else '' }}">
                                <button type="button" class="btn-mic" data-target="nombre_ordenador" aria-label="Dictar nombre del orde√±ador">üé§ Dictar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 2: Identificaci√≥n de la Vaca -->
                <div class="form-section">
                    <h3 class="section-title">üêÑ Identificaci√≥n de la Vaca</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_vaca">ID de la Vaca:</label>
                            <input type="text" id="id_vaca" name="id_vaca" required placeholder="Ejemplo: V001" value="{{ registro.id_vaca if registro else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="nombre_vaca">Nombre de la Vaca:</label>
                            <div class="input-action">
                                <input type="text" id="nombre_vaca" name="nombre_vaca" required placeholder="Ingrese el nombre de la vaca" value="{{ registro.nombre_vaca if registro else '' }}">
                                <button type="button" class="btn-mic" data-target="nombre_vaca" aria-label="Dictar nombre de la vaca">üé§ Dictar</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edad">Edad:</label>
                            <div class="number-stepper">
                                <button type="button" class="stepper-btn" data-target="edad" data-step="-1" aria-label="Restar edad">‚àí</button>
                                <input type="number" id="edad" name="edad" min="0" step="1" inputmode="numeric" required placeholder="Edad en a√±os" value="{{ registro.edad if registro else '' }}">
                                <button type="button" class="stepper-btn" data-target="edad" data-step="1" aria-label="Sumar edad">Ôºã</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 3: Estado y Condici√≥n -->
                <div class="form-section">
                    <h3 class="section-title">üìã Estado y Condici√≥n</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="estado_productivo">Estado Productivo:</label>
                            <select id="estado_productivo" name="estado_productivo" required>
                                <option value="">Seleccione...</option>
                                <option value="Productiva" {{ 'selected' if registro and registro.estado_productivo=='Productiva' else '' }}>Productiva</option>
                                <option value="No Productiva" {{ 'selected' if registro and registro.estado_productivo=='No Productiva' else '' }}>No Productiva</option>
                                <option value="En Reposo" {{ 'selected' if registro and registro.estado_productivo=='En Reposo' else '' }}>En Reposo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vaca_parida">Vaca Parida:</label>
                            <select id="vaca_parida" name="vaca_parida" required>
                                <option value="">Seleccione...</option>
                                <option value="S√≠" {{ 'selected' if registro and registro.vaca_parida=='S√≠' else '' }}>S√≠</option>
                                <option value="No" {{ 'selected' if registro and registro.vaca_parida=='No' else '' }}>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vaca_seca">Vaca Seca:</label>
                            <select id="vaca_seca" name="vaca_seca" required>
                                <option value="">Seleccione...</option>
                                <option value="S√≠" {{ 'selected' if registro and registro.vaca_seca=='S√≠' else '' }}>S√≠</option>
                                <option value="No" {{ 'selected' if registro and registro.vaca_seca=='No' else '' }}>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="condicion_corporal">Condici√≥n Corporal:</label>
                            <select id="condicion_corporal" name="condicion_corporal" required>
                                <option value="">Seleccione...</option>
                                <option value="Flaca" {{ 'selected' if registro and registro.condicion_corporal=='Flaca' else '' }}>Flaca</option>
                                <option value="Normal" {{ 'selected' if registro and registro.condicion_corporal=='Normal' else '' }}>Normal</option>
                                <option value="Gorda" {{ 'selected' if registro and registro.condicion_corporal=='Gorda' else '' }}>Gorda</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 4: Sanidad y Enfermedades -->
                <div class="form-section">
                    <h3 class="section-title">üíâ Sanidad</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Registro sanitario (Vacunas):</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="vacunas" value="Brucella" {{ 'checked' if vacunas_sel and 'Brucella' in vacunas_sel else '' }}> Brucella</label>
                                <label><input type="checkbox" name="vacunas" value="Aftosa" {{ 'checked' if vacunas_sel and 'Aftosa' in vacunas_sel else '' }}> Aftosa</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Enfermedades:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="enfermedades" value="Mastitis" {{ 'checked' if enfermedades_sel and 'Mastitis' in enfermedades_sel else '' }}> Mastitis</label>
                                <label><input type="checkbox" name="enfermedades" value="Cojeras" {{ 'checked' if enfermedades_sel and 'Cojeras' in enfermedades_sel else '' }}> Cojeras</label>
                                <label><input type="checkbox" name="enfermedades" value="Hipocalcemia" {{ 'checked' if enfermedades_sel and 'Hipocalcemia' in enfermedades_sel else '' }}> Hipocalcemia</label>
                                <label><input type="checkbox" name="enfermedades" value="Ninguna" id="enf-ninguna" {{ 'checked' if enfermedades_sel and 'Ninguna' in enfermedades_sel else '' }}> Ninguna</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 5: Informaci√≥n Reproductiva -->
                <div class="form-section">
                    <h3 class="section-title">üçº Informaci√≥n Reproductiva</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="numero_crias">N√∫mero de Cr√≠as:</label>
                            <div class="number-stepper">
                                <button type="button" class="stepper-btn" data-target="numero_crias" data-step="-1" aria-label="Restar cr√≠as">‚àí</button>
                                <input type="number" id="numero_crias" name="numero_crias" min="0" step="1" inputmode="numeric" required placeholder="0" value="{{ registro.numero_crias if registro else '' }}">
                                <button type="button" class="stepper-btn" data-target="numero_crias" data-step="1" aria-label="Sumar cr√≠as">Ôºã</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="numero_parto">N√∫mero de Parto:</label>
                            <div class="number-stepper">
                                <button type="button" class="stepper-btn" data-target="numero_parto" data-step="-1" aria-label="Restar partos">‚àí</button>
                                <input type="number" id="numero_parto" name="numero_parto" min="0" step="1" inputmode="numeric" required placeholder="0" value="{{ registro.numero_parto if registro else '' }}">
                                <button type="button" class="stepper-btn" data-target="numero_parto" data-step="1" aria-label="Sumar partos">Ôºã</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 6: Producci√≥n de Leche -->
                <div class="form-section">
                    <h3 class="section-title">ü•õ Producci√≥n de Leche</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="litros">Litros de Leche:</label>
                            <div class="number-stepper">
                                <button type="button" class="stepper-btn" data-target="litros" data-step="-0.1" aria-label="Restar litros">‚àí</button>
                                <input type="number" id="litros" name="litros" step="0.1" min="0" inputmode="decimal" required placeholder="0.0" value="{{ registro.litros if registro else '' }}">
                                <button type="button" class="stepper-btn" data-target="litros" data-step="0.1" aria-label="Sumar litros">Ôºã</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 7: Fotograf√≠a -->
                <div class="form-section">
                    <h3 class="section-title">üì∑ Fotograf√≠a de la Vaca</h3>
                    <div class="form-group">
                        <label for="foto">Foto de la Vaca:</label>
                        <div class="camera-options">
                            <button type="button" id="btnActivarCamara" class="btn-camera">üì∑ Activar C√°mara</button>
                            <button type="button" id="btnSeleccionarArchivo" class="btn-file">üìÅ Seleccionar Archivo</button>
                        </div>
                        <input type="file" id="foto" name="foto" accept="image/*" style="display: none;">
                        
                        <div id="cameraContainer" class="camera-container" style="display: none;">
                            <video id="video" autoplay playsinline></video>
                            <div class="camera-controls">
                                <button type="button" id="btnTomarFoto" class="btn-capture">üì∏ Tomar Foto</button>
                                <button type="button" id="btnCerrarCamara" class="btn-close-camera">‚úñ Cerrar C√°mara</button>
                            </div>
                        </div>
                        
                        <canvas id="canvas" style="display: none;"></canvas>
                        <div id="preview" class="preview-container">
                            {% if edicion and registro and registro.imagen_base64 %}
                                <img src="data:image/jpeg;base64,{{ registro.imagen_base64 }}" alt="Vista previa">
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-submit">{{ 'Actualizar Registro' if edicion else 'Guardar Registro' }}</button>
                    <button type="reset" class="btn-reset">Limpiar Formulario</button>
                </div>
            </form>

            <div id="mensaje" class="mensaje"></div>
        </div>
    </div>

    <script>
        let stream = null;
        let fotoCapturada = null;

        // Elementos del DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const cameraContainer = document.getElementById('cameraContainer');
        const inputFoto = document.getElementById('foto');
        const btnActivarCamara = document.getElementById('btnActivarCamara');
        const btnSeleccionarArchivo = document.getElementById('btnSeleccionarArchivo');
        const btnTomarFoto = document.getElementById('btnTomarFoto');
        const btnCerrarCamara = document.getElementById('btnCerrarCamara');
        const vacaForm = document.getElementById('vacaForm');

        // Activar c√°mara
        btnActivarCamara.addEventListener('click', async function() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
                cameraContainer.style.display = 'block';
                preview.innerHTML = '';
                fotoCapturada = null;
            } catch (error) {
                alert('Error al acceder a la c√°mara: ' + error.message);
            }
        });

        // Seleccionar archivo
        btnSeleccionarArchivo.addEventListener('click', function() {
            inputFoto.click();
        });

        // Vista previa de archivo seleccionado
        inputFoto.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Vista previa">`;
                    cerrarCamara();
                }
                reader.readAsDataURL(file);
                fotoCapturada = null;
            }
        });

        // Tomar foto
        btnTomarFoto.addEventListener('click', function() {
            const context = canvas.getContext('2d');
            
            // Reducir el tama√±o de la imagen para optimizar (Excel tiene l√≠mite de 32,767 caracteres por celda)
            const maxWidth = 640;
            const maxHeight = 640;
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            // Calcular nuevas dimensiones manteniendo la proporci√≥n
            if (width > height) {
                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            context.drawImage(video, 0, 0, width, height);
            
            // Mostrar vista previa
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            preview.innerHTML = `<img src="${imageData}" alt="Foto capturada">`;
            
            // Convertir a Blob para enviar con compresi√≥n
            canvas.toBlob(function(blob) {
                fotoCapturada = blob;
            }, 'image/jpeg', 0.7);
            
            cerrarCamara();
        });

        // Cerrar c√°mara
        btnCerrarCamara.addEventListener('click', cerrarCamara);

        function cerrarCamara() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraContainer.style.display = 'none';
        }

    // Variables de modo edici√≥n (desde data-* del formulario)
    const isEdit = vacaForm.dataset.isEdit === '1';
    const hasExistingImage = vacaForm.dataset.hasImage === '1';

        // Validar antes de enviar el formulario
        vacaForm.addEventListener('submit', function(e) {
            const noNuevaFoto = (!fotoCapturada && !inputFoto.files.length);
            if (noNuevaFoto) {
                if (!isEdit || (isEdit && !hasExistingImage)) {
                    e.preventDefault();
                    alert('Por favor, toma una foto o selecciona un archivo');
                    return false;
                }
            }

            // Si hay foto capturada, crear un archivo y agregarlo al input
            if (fotoCapturada) {
                e.preventDefault();
                const timestamp = new Date().getTime();
                const file = new File([fotoCapturada], `foto_${timestamp}.jpg`, { type: 'image/jpeg' });
                
                // Crear un DataTransfer para agregar el archivo al input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                inputFoto.files = dataTransfer.files;
                
                // Enviar el formulario
                vacaForm.submit();
            }
        });

        // Limpiar formulario
        vacaForm.addEventListener('reset', function() {
            preview.innerHTML = '';
            cerrarCamara();
            fotoCapturada = null;
        });

        // Dictado por voz (Web Speech API) para facilitar a quienes no escriben
        function iniciarDictadoPara(campoId, boton) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Tu navegador no soporta dictado por voz. Prueba con Chrome en Android o escritorio.');
                return;
            }
            const reconocimiento = new SpeechRecognition();
            reconocimiento.lang = 'es-ES';
            reconocimiento.interimResults = false;
            reconocimiento.maxAlternatives = 1;

            const input = document.getElementById(campoId);
            const textoOriginal = boton.textContent;
            boton.disabled = true;
            boton.textContent = 'üéôÔ∏è Escuchando‚Ä¶';

            reconocimiento.onresult = (event) => {
                const transcripcion = event.results[0][0].transcript;
                input.value = transcripcion;
            };
            reconocimiento.onerror = () => {
                alert('No se pudo reconocer la voz. Intenta hablar claro y cerca del micr√≥fono.');
            };
            reconocimiento.onend = () => {
                boton.disabled = false;
                boton.textContent = textoOriginal;
            };
            reconocimiento.start();
        }

        document.querySelectorAll('.btn-mic').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-target');
                iniciarDictadoPara(target, btn);
            });
        });

        // Botones +/‚àí para n√∫meros (evita teclear)
        function ajustarNumero(input, delta) {
            const step = parseFloat(input.getAttribute('step') || '1');
            const min = input.hasAttribute('min') ? parseFloat(input.getAttribute('min')) : -Infinity;
            const max = input.hasAttribute('max') ? parseFloat(input.getAttribute('max')) : Infinity;
            const valorActual = input.value === '' ? 0 : parseFloat(input.value);
            // Redondear al m√∫ltiplo de step para evitar decimales raros
            const nuevo = Math.max(min, Math.min(max, (valorActual + delta)));
            const decimales = (step.toString().split('.')[1] || '').length;
            input.value = nuevo.toFixed(decimales);
            input.dispatchEvent(new Event('change'));
        }

        document.querySelectorAll('.stepper-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-target');
                const delta = parseFloat(btn.getAttribute('data-step'));
                const input = document.getElementById(target);
                ajustarNumero(input, delta);
            });
        });

        // L√≥gica para 'Ninguna' en Enfermedades (excluyente)
        const enfNinguna = document.getElementById('enf-ninguna');
        const enfChecks = Array.from(document.querySelectorAll('input[name="enfermedades"]'));
        enfChecks.forEach(chk => {
            chk.addEventListener('change', () => {
                if (chk === enfNinguna && enfNinguna.checked) {
                    // Desmarcar todas las dem√°s
                    enfChecks.forEach(o => { if (o !== enfNinguna) o.checked = false; });
                } else if (chk !== enfNinguna && chk.checked) {
                    // Desmarcar 'Ninguna'
                    enfNinguna.checked = false;
                }
            });
        });

        // Mostrar mensajes de √©xito o error
        const urlParams = new URLSearchParams(window.location.search);
        const mensaje = document.getElementById('mensaje');
        
        if (urlParams.get('success') === 'true') {
            mensaje.innerHTML = '<p class="success">‚úì Registro guardado exitosamente</p>';
            setTimeout(() => {
                mensaje.innerHTML = '';
                window.history.replaceState({}, document.title, window.location.pathname);
            }, 3000);
        } else if (urlParams.get('error')) {
            mensaje.innerHTML = `<p class="error">‚úó Error: ${urlParams.get('error')}</p>`;
        }
    </script>
</body>
</html>
